name: SLA Trends
on:
  push:
    branches: [ main, master ]
  schedule:
    - cron: '5 4 * * *'
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: Prepare dirs
        run: mkdir -p artifacts/modelo100
      - name: Snapshot
        run: node scripts/modelo100.sla.snapshot.mjs || ALLOW_EMPTY=1 node scripts/modelo100.sla.snapshot.mjs
      - name: Trends
        run: node scripts/modelo100.sla.trends.mjs || ALLOW_EMPTY=1 node scripts/modelo100.sla.trends.mjs
      - name: Alerts (global)
        run: node scripts/modelo100.sla.alerts.mjs || ALLOW_EMPTY=1 node scripts/modelo100.sla.alerts.mjs
      - name: Notify (global; dry-run unless NOTIFY_ENABLE=1)
        run: node scripts/modelo100.sla.notify.mjs || true
      - name: Owner Snapshot
        run: node scripts/modelo100.sla.owner.snapshot.mjs || ALLOW_EMPTY=1 node scripts/modelo100.sla.owner.snapshot.mjs
      - name: Owner Trends
        run: node scripts/modelo100.sla.owners.trends.mjs || ALLOW_EMPTY=1 node scripts/modelo100.sla.owners.trends.mjs
      - name: Owner Alerts
        run: node scripts/modelo100.sla.owner.alerts.mjs || ALLOW_EMPTY=1 node scripts/modelo100.sla.owner.alerts.mjs
      - name: Owner Escalations
        run: node scripts/modelo100.sla.owner.escalate.mjs || ALLOW_EMPTY=1 node scripts/modelo100.sla.owner.escalate.mjs
      - name: Owner Notify (dry-run unless NOTIFY_ENABLE=1)
        run: node scripts/modelo100.sla.owner.notify.mjs || true
      - name: Generate Owner HTML
        run: node scripts/modelo100.sla.owners.html.mjs || true
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sla-bundle
          path: |
            artifacts/modelo100/sla.day-*.json
            artifacts/modelo100/sla.trends.json
            artifacts/modelo100/sla.trends.csv
            artifacts/modelo100/sla.alerts.json
            artifacts/modelo100/sla.owner.day-*.json
            artifacts/modelo100/sla.owner.trends.json
            artifacts/modelo100/sla.owner.trends.csv
            artifacts/modelo100/sla.owner.alerts.json
            artifacts/modelo100/sla.owner.escalations.json
            artifacts/modelo100/sla.owner.escalations.csv
            artifacts/modelo100/sla.owners.html
          if-no-files-found: warn
      - name: Job Summary
        run: |
          echo "### SLA Summary" >> $GITHUB_STEP_SUMMARY
          if test -f artifacts/modelo100/sla.trends.json; then
            D7=$(jq -r '.rollups.d7.breach_rate' artifacts/modelo100/sla.trends.json)
            D30=$(jq -r '.rollups.d30.breach_rate' artifacts/modelo100/sla.trends.json)
            D90=$(jq -r '.rollups.d90.breach_rate' artifacts/modelo100/sla.trends.json)
            echo "- Global Breach rate: 7d=$D7%  30d=$D30%  90d=$D90%" >> $GITHUB_STEP_SUMMARY
          fi
          if test -f artifacts/modelo100/sla.owner.alerts.json; then
            echo "### Owners over budget (any window)" >> $GITHUB_STEP_SUMMARY
            jq -r '.owners[] | select(.overall!="ok") | "- \(.owner): overall=\(.overall) d7=\(.windows.d7.status)(\(.windows.d7.rate)%) d30=\(.windows.d30.status)(\(.windows.d30.rate)%) d90=\(.windows.d90.status)(\(.windows.d90.rate)%)"' artifacts/modelo100/sla.owner.alerts.json >> $GITHUB_STEP_SUMMARY || true
          fi
          if test -f artifacts/modelo100/sla.owner.escalations.json; then
            echo "### Escalations" >> $GITHUB_STEP_SUMMARY
            jq -r '.rows[] | select(.level!="none") | "- \(.owner): level=\(.level) streak=\(.streak) d7=\(.d7_status)(\(.d7_rate)%)"' artifacts/modelo100/sla.owner.escalations.json >> $GITHUB_STEP_SUMMARY || true
          fi
