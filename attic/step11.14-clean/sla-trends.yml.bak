name: SLA Trends
on:
  push:
    branches: [ main, master ]
  schedule:
    - cron: '5 4 * * *'
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: Prepare dirs
        run: mkdir -p artifacts/modelo100
      - name: Snapshot
        run: node scripts/modelo100.sla.snapshot.mjs || ALLOW_EMPTY=1 node scripts/modelo100.sla.snapshot.mjs
      - name: Trends
        run: node scripts/modelo100.sla.trends.mjs || ALLOW_EMPTY=1 node scripts/modelo100.sla.trends.mjs
      - name: Alerts
        run: node scripts/modelo100.sla.alerts.mjs || ALLOW_EMPTY=1 node scripts/modelo100.sla.alerts.mjs
      - name: Notify (dry-run unless NOTIFY_ENABLE=1)
        run: node scripts/modelo100.sla.notify.mjs || true
      - name: Upload SLA artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sla-trends
          path: |
            artifacts/modelo100/sla.day-*.json
            artifacts/modelo100/sla.trends.json
            artifacts/modelo100/sla.trends.csv
            artifacts/modelo100/sla.alerts.json
          if-no-files-found: warn
      - name: Job Summary (SLA)
        run: |
          echo "### SLA Trends Summary" >> $GITHUB_STEP_SUMMARY
          if test -f artifacts/modelo100/sla.trends.json; then
            D7=$(jq -r '.rollups.d7.breach_rate' artifacts/modelo100/sla.trends.json)
            D30=$(jq -r '.rollups.d30.breach_rate' artifacts/modelo100/sla.trends.json)
            D90=$(jq -r '.rollups.d90.breach_rate' artifacts/modelo100/sla.trends.json)
            echo "- Breach rate 7d: $D7%" >> $GITHUB_STEP_SUMMARY
            echo "- Breach rate 30d: $D30%" >> $GITHUB_STEP_SUMMARY
            echo "- Breach rate 90d: $D90%" >> $GITHUB_STEP_SUMMARY
          else
            echo "- No trends found" >> $GITHUB_STEP_SUMMARY
          fi
          if test -f artifacts/modelo100/sla.alerts.json; then
            OVERALL=$(jq -r '.overall' artifacts/modelo100/sla.alerts.json)
            echo "- Overall status: $OVERALL" >> $GITHUB_STEP_SUMMARY
          fi
      - name: Owner Snapshot
        run: node scripts/modelo100.sla.owner.snapshot.mjs || ALLOW_EMPTY=1 node scripts/modelo100.sla.owner.snapshot.mjs
      - name: Owner Trends
        run: node scripts/modelo100.sla.owners.trends.mjs || ALLOW_EMPTY=1 node scripts/modelo100.sla.owners.trends.mjs
      - name: Generate Owner HTML
        run: node scripts/modelo100.sla.owners.html.mjs || true
      - name: Upload owner artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sla-owners
          path: |
            artifacts/modelo100/sla.owner.day-*.json
            artifacts/modelo100/sla.owner.trends.json
            artifacts/modelo100/sla.owner.trends.csv
            artifacts/modelo100/sla.owners.html
          if-no-files-found: warn
      - name: Job Summary (Owners)
        run: |
          echo "### SLA Owners (Top 5, 7d)" >> $GITHUB_STEP_SUMMARY
          if test -f artifacts/modelo100/sla.owner.trends.json; then
            jq -r '.windows.d7[:5][] | "- \(.owner): \(.breach_rate)% (\(.breaches)/\(.totals))"' artifacts/modelo100/sla.owner.trends.json >> $GITHUB_STEP_SUMMARY || true
          else
            echo "- No owner trends" >> $GITHUB_STEP_SUMMARY
          fi
